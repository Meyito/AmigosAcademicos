<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Para la correcta visualización de este sitio, mantener las 3 etiquetas meta en la parte superior, y todas las demas justo despues de este comentario -->
    <title>Amigos Académicos</title>

    <!-- Hojas de estilos -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet" >
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css">
    <!-- Las siguientes lineas garantizan el funcionamiento de este sitio en versiones antiguas de Internet Explorer -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>
  <body>
    <!--Navbar logueado-->
    <nav class="navbar navbar-default navbar-fixed-top" id="navbar">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
            <a class="navbar-brand" href="index.php">
              <img src="img/logo.png" alt="Amigos Académicos">
            </a>
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar" aria-expanded="false" >
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            <h1 class="text-center">Amigos Académicos</h1>

          </div>
        </div>       
      </div>
    </nav>
    <div class="container-fluid front" id="front">
        <div class="row">
          <div class="col-lg-2 col-md-3 col-sm-3 sidebar collapse navbar-collapse" id="sidebar">
            <a href="index.php" class="wh">
              <div class="row">
                <div class="col-md-4 col-sm-4 col-sm-offset-4 col-md-offset-0 hidden-xs">
                  <img src="img/avatars/h1.png" alt="avatar" class="img-responsive avatar">
                </div>
                <div class="col-md-8 col-sm-12 text-center">
                  <h4>Nombre Apellido</h4>
                  <h5>Administrador</h5>
                </div>
              </div>
            </a>
              <div class="row text-center">
                <a href="#" class="wh" data-toggle="tooltip" title="Cambiar el avatar">
                  <div class="col-xs-4 button-help-sidebar">
                    <span class="glyphicon glyphicon-camera" aria-hidden="true"></span>
                  </div>
                </a>
                <a href="#" class="wh" data-toggle="tooltip" title="Ayuda">
                  <div class="col-xs-4 button-help-sidebar">
                    <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                  </div>
                </a>
                <a href="#" class="wh" data-toggle="tooltip" title="Cerrar sesión">
                  <div class="col-xs-4 button-help-sidebar">
                    <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
                  </div>
                </a>
              </div>
              <a href="#" class="button-sidebar">
                <div class="row item-sidebar">
                  <div class="col-xs-3 col-sm-2 col-md-2 col-lg-4">
                    <span class="glyphicon glyphicon-stats"></span>
                  </div>
                  <div class="col-xs-9 col-sm-10 col-md-9 col-lg-8">Nombre del item</div>
                </div>
              </a>
              <a href="#" class="button-sidebar">
                <div class="row item-sidebar">
                  <div class="col-xs-3 col-sm-2 col-md-2 col-lg-4">
                    <span class="glyphicon glyphicon-stats"></span>
                  </div>
                  <div class="col-xs-9 col-sm-10 col-md-9 col-lg-8">Nombre del item</div>
                </div>
              </a>
              <a href="#" class="button-sidebar">
                <div class="row item-sidebar">
                  <div class="col-xs-3 col-sm-2 col-md-2 col-lg-4">
                    <span class="glyphicon glyphicon-stats"></span>
                  </div>
                  <div class="col-xs-9 col-sm-10 col-md-9 col-lg-8">Nombre del item</div>
                </div>
              </a>
          </div>
          <div class="col-lg-10 col-md-9 col-sm-9 text-center">
            <h3>Estadisticas</h3>
            <div class="panel panel-default center-block center-text">
              <div class="panel-heading">
                <h3 class="panel-title">Asistencia por curso</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-9">
                    <div id="AsistenciaPorCursoChart"></div>
                  </div>
                  <div class="col-md-3">
                    <p><strong>Calificación promedio: </strong><span  class="label label-danger" id="calificacionPromedioCurso"> </span></p>
                    <p>Mostrar cursos de:</p>
                    <select name="seleccionarAmigo" id="seleccionarAsistenciaPorCurso"  class="form-control" onchange="cambiarVistaPorAmigo()">
                      <option value="Todos">Todos</option>
                    </select> 
                  </div>
                </div>
              </div>
            </div>
            <div class="panel panel-default center-block center-text">
              <div class="panel-heading" data-toggle="tooltip" data-placement="top" title="Pulsando la barra de una materia es posible ver las estadisticas de los temas relacionados.">
                <h3 class="panel-title">Asistencia por materias</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-9">
                    <div id="AsistenciaPorMateriaChart"></div>
                  </div>
                  <div class="col-md-3">
                    <p><strong>Calificación promedio: </strong><span  class="label label-danger"id="calificacionPromedioMaterias"> </span></p>
                    
                  </div>
                </div>
              </div>
            </div>
            <div class="panel panel-default center-block center-text">
              <div class="panel-heading">
                <h3 class="panel-title">Estudiantes con mayor frecuencia</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-10 col-md-offset-1">
                      <p>Filtrar por:</p>
                      <div class="row">
                        <div class="col-md-6">
                          <select class="form-control" id="estudiantesFrecuenciaMaterias" onchange="selectFrecuenciaMateria();recargarTablaFrecuencia()">
                            <option value="todo">Todas las materias</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <select class="form-control" id="estudiantesFrecuenciaTemas" onchange="recargarTablaFrecuencia()" disabled>
                            <option value="todo">Todos los temas</option>
                          </select><br>
                        </div>
                      </div>
                      <div class="row">
                        <table id="Estudiantes-frecuencia" class="table table-striped table-bordered" cellspacing="0" width="100%">
                          <thead>
                              <tr>
                                  <th>Estudiante</th>
                                  <th>Número de Asistencias</th>
                              </tr>
                          </thead>
                          <tfoot>
                              <tr>
                                  <th>Estudiante</th>
                                  <th>Número de Asistencias</th>
                              </tr>
                          </tfoot>
                        </table>
                      </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="panel panel-default center-block center-text">
                  <div class="panel-heading">
                    <h3 class="panel-title">Asesoria por amigo académico</h3>
                  </div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-md-12">
                        <div id="AsistenciaPorAmigoChart"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="panel panel-default center-block center-text">
                  <div class="panel-heading" data-toggle="tooltip" data-placement="top" title="Pulsando el espacio de un amigo académico, se despliega su información.">
                    <h3 class="panel-title">Estudiantes en amigos Academicos vs. Total de estudiantes</h3>
                  </div>
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-md-12">
                        <div id="totalEstudiantesChart"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div> 
          </div>
        </div>
    </div>
    <footer id="footer">
       <div class="container">
        <div class="col-sm-3 col-xs-6 text-center">
            <img src="img/ufps_logo.jpg" class="img-responsive" alt="UFPS">
        </div>
        <div class="col-sm-3 col-xs-6 hidden-md hidden-sm hidden-lg text-center">
            <img src="img/ingsistemas_logo.png" class="img-responsive" alt="Ing. Sistemas UFPS">
        </div>
        <div class="col-sm-6 col-xs-12 text-center">
          <p>Universidad Francisco de Paula Santander</p>
          <p>Melissa Delgado - Daniel Vega - Gerson Lázaro</p>
          <p>2015</p>
        </div>
         <div class="col-sm-3 col-xs-6 hidden-xs text-center">
          <img src="img/ingsistemas_logo.png" class="img-responsive" alt="Ing. Sistemas UFPS">
        </div>
      </div>
    </footer>
    <!-- Librerias para el funcionamiento-->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/index.js"></script>
    <script>
      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })
      sidebarAdjust();

  </script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript">

    //COMUNES
    google.load('visualization', '1', {'packages':['corechart']});

    function obtenerJSONDataAsync(string, callbackOrigin){
      function fetchJSONFile(path, callbackOrigin, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                        var data = httpRequest.responseText;
                        if (callback) callback(data);
                    }
                }
            };
          httpRequest.open('GET', path);
          httpRequest.send(); 
      }
      fetchJSONFile("getData.php?"+string, callbackOrigin, function(data){
          callbackOrigin(data);
      });

    }


    //GRAFICO ASISTENCIA POR CURSO
    var seleccionarAmigoAcademico = "Todos";
    google.setOnLoadCallback(drawAsistenciaCursoDecorator);
    function drawAsistenciaCursoDecorator(){
      obtenerJSONDataAsync("peticion=asistenciaCursosAA&&asistenciaCursoAA="+seleccionarAmigoAcademico, drawAsistenciaCurso);
    }
    function drawAsistenciaCurso(jsonData) {
      var data = new google.visualization.DataTable(jsonData);
      var chart = new google.visualization.ColumnChart(document.getElementById('AsistenciaPorCursoChart'));
      var options    = {
        legend: { position: 'none' },
        hAxis: {
          title: 'Cursos'
        },
        vAxis: {
          title: 'Número de estudiantes'
        },
        fontSize: 10
      };
      chart.draw(data, options);
      cargarCalificacionPromedioCursoDecorator();
      sidebarAdjust();
    }
    function cargarCalificacionPromedioCursoDecorator(){
      obtenerJSONDataAsync("peticion=promedioAACalificacionCurso&&promedioCursoAA="+seleccionarAmigoAcademico, cargarCalificacionPromedioCurso);
    }
    function cargarCalificacionPromedioCurso(data){
      var span = document.getElementById("calificacionPromedioCurso");
      var jsonData = JSON.parse(data);
      span.innerHTML = jsonData.promedio;
    }
    function cambiarVistaPorAmigo(){
      var select = document.getElementById("seleccionarAsistenciaPorCurso");
      for(i = 0; i < select.childNodes.length; i++){
        if(select.options[i].selected){
          seleccionarAmigoAcademico = select.options[i].value;
          drawAsistenciaCursoDecorator();
        }
      }
    }

    function llenarSelectAsistenciaCursoDecorator(){
      obtenerJSONDataAsync("peticion=selectAsistenciaCurso", llenarSelectAsistenciaCurso);
    }
    llenarSelectAsistenciaCursoDecorator();
    function llenarSelectAsistenciaCurso(data){
      var jsonData = JSON.parse(data);
      var options = '<option value="Todos">Todos</option>';
      for(i=0;i<jsonData.length;i++){
        var obj = jsonData[i];
        options += '<option value="'+obj["id"]+'">'+obj["nombre"]+'</option>';
      }
      document.getElementById("seleccionarAsistenciaPorCurso").innerHTML = options;

    } 


    //GRAFICO ASISTENCIA POR MATERIA Y TEMA
    google.setOnLoadCallback(drawAsistenciaMateriaDecorator);
    function drawAsistenciaMateriaDecorator(){
      obtenerJSONDataAsync("peticion=asistenciaMateria", drawAsistenciaMateria);
    }
    function drawAsistenciaMateria(jsonData) {
      var data = new google.visualization.DataTable(jsonData);
      var chart = new google.visualization.BarChart(document.getElementById('AsistenciaPorMateriaChart'));
      var options    = {
        legend: { position: 'none' },
        hAxis: {
          title: 'Cursos'
        },
        vAxis: {
          title: 'Número de estudiantes'
        },
        fontSize: 10
      };
      chart.draw(data, options);
      sidebarAdjust();
      google.visualization.events.addListener(chart, 'select', selectHandler);
      function selectHandler() {
        var _data = JSON.parse(jsonData);
        var selection = chart.getSelection();
        var id;
        for (var i = 0; i < selection.length; i++) {
          var item = selection[i];
          id = _data["rows"][item.row]["c"][0]["p"];
          location.href='index.php?accion=estadisticaIndividual&materia='+id;
        }
      }

      cargarCalificacionPromedioMateriasDecorator();
    }
    function cargarCalificacionPromedioMateriasDecorator(){
      obtenerJSONDataAsync("peticion=calificacionMateriaPromedio", cargarCalificacionPromedioMaterias);
    }
    function cargarCalificacionPromedioMaterias(data){
      var span = document.getElementById("calificacionPromedioMaterias");
      var jsonData = JSON.parse(data);
      span.innerHTML = jsonData.promedio;
    }




    //ESTUDIANTES CON MAS FRECUENCIA

    function selectFrecuenciaMateria(){
      var selectMaterias = document.getElementById("estudiantesFrecuenciaMaterias");
      var selectTemas = document.getElementById("estudiantesFrecuenciaTemas");
      for(i = 0; i < (selectMaterias.childNodes.length); i++){
        if(selectMaterias.options[i].selected){
          if(selectMaterias.options[i].value == "todo"){
            selectTemas.disabled = true;
          }else{
            cargarFrecuenciaTemasDecorator(selectMaterias.options[i].value);
            selectTemas.disabled = false;
          }
          break;
        }
      }
    }
   

    function cargarFrecuenciaMateriasDecorator(){
      obtenerJSONDataAsync("peticion=ListaMaterias", cargarFrecuenciaMaterias);
    }
    cargarFrecuenciaMateriasDecorator();
    function cargarFrecuenciaMaterias(data){
      var selectMaterias = document.getElementById("estudiantesFrecuenciaMaterias");
      var materias = '<option value="todo">Todas las materias</option>';
      jsonData = JSON.parse(data);
      for(i=0;i<jsonData.length;i++){
        var obj = jsonData[i];
        materias += '<option value="'+obj["id"]+'">'+obj["nombre"]+'</option>';
      }
      selectMaterias.innerHTML = materias;
    }

    function cargarFrecuenciaTemasDecorator(idMateria){
      obtenerJSONDataAsync("peticion=ListaTemas&&idMateria="+idMateria, cargarFrecuenciaTemas);
    }
    function cargarFrecuenciaTemas(data){
      var temas = '<option value="todo">Todos los temas</option>';
      var selectTemas = document.getElementById("estudiantesFrecuenciaTemas");
      jsonData = JSON.parse(data);
      for(i=0;i<jsonData.length;i++){
        var obj = jsonData[i];
        temas += '<option value="'+obj["id"]+'">'+obj["nombre"]+'</option>';
      }
      selectTemas.innerHTML = temas;
    }

    function cargarTablaFrecuenciaDecorator(idMateria, idTema){
      obtenerJSONDataAsync("peticion=TablaFrecuencia&&materia="+idMateria+"&&tema="+idTema, cargarTablaFrecuencia);
    }
    function recargarTablaFrecuencia(){
      cargarTablaFrecuenciaDecorator(document.getElementById("estudiantesFrecuenciaMaterias").value, document.getElementById("estudiantesFrecuenciaTemas").value);
    }
    cargarTablaFrecuenciaDecorator(document.getElementById("estudiantesFrecuenciaMaterias").value, document.getElementById("estudiantesFrecuenciaTemas").value);
    var tabla;
    function cargarTablaFrecuencia(data){
      var jsonData = JSON.parse(data);
      var msg = '<thead><tr><th>Estudiante</th><th>Número de Asistencias</th></tr></thead><tfoot><tr><th>Estudiante</th><th>Número de Asistencias</th></tr></tfoot>';
      for(i=0;i<jsonData.length;i++){
        var obj = jsonData[i];
        msg += '<tr><td>'+obj["nombre"]+'</td><td>'+obj["asesorias"]+'</td></tr>';
      }
      document.getElementById("Estudiantes-frecuencia").innerHTML = msg;
      if(tabla != undefined){
        tabla.destroy();
      }
          
          tabla = $('#Estudiantes-frecuencia').DataTable({
              "order": [[ 1, "desc" ]],
              "language": {
                  "lengthMenu": "Mostrar _MENU_ estudiantes por página",
                  "zeroRecords": "No encontrado",
                  "paginate": {
                      "first":      "Primero",
                      "last":       "Último",
                      "next":       "Siguiente",
                      "previous":   "Anterior"
                  },
                  "info": "Mostrando página _PAGE_ de _PAGES_",
                  "infoEmpty": "No hay resultados disponibles",
                  "infoFiltered": "(fitrado de _MAX_ estudiantes)"
              }
          });
    }




    //GRAFICO ASISTENCIA POR AMIGO ACADEMICO
    google.setOnLoadCallback(drawAsesoriaPorAmigoDecorator);
    function drawAsesoriaPorAmigoDecorator(){
      obtenerJSONDataAsync("peticion=asesoriaAmigo", drawAsesoriaPorAmigo);
    }
    function drawAsesoriaPorAmigo(jsonData) {
      var data = new google.visualization.DataTable(jsonData);
      var chart = new google.visualization.PieChart(document.getElementById('AsistenciaPorAmigoChart'));
      var options = {
        height: 300
      };
      chart.draw(data, options);
      sidebarAdjust();
      google.visualization.events.addListener(chart, 'select', selectHandler);
      function selectHandler() {
        var _data = JSON.parse(jsonData);
        var selection = chart.getSelection();
        var id;
        for (var i = 0; i < selection.length; i++) {
          var item = selection[i];
          console.log(_data["rows"][item.row]["c"][1]["v"]);
          id = _data["rows"][item.row]["c"][0]["p"];
        }
      }

    }



    //COMPARATIVA FRENTE A POBLACION ACADEMICA
    google.setOnLoadCallback(drawtotalEstudiantesDecorator);
    function drawtotalEstudiantesDecorator(){
      obtenerJSONDataAsync("peticion=totalEstudiantes", drawtotalEstudiantes);
    }
    function drawtotalEstudiantes(jsonData) {
      var data = new google.visualization.DataTable(jsonData);
      var chart = new google.visualization.PieChart(document.getElementById('totalEstudiantesChart'));
      var options = {
        height: 300
      };
      chart.draw(data, options);
      sidebarAdjust();

    }
    </script>
  </body>
</html>